<!DOCTYPE html>
<html>
  <head>
    <style>
      html {
        background-color: #0f2d37;
        color: white;
      }
      input {
        height: 10em;
        width: 80vw;
        text-align: center;
        border: dotted 5px #77dce9;
      }
      .dragOver {
        border: dotted 5px #d2eefb;
      }
      th {
        text-align: left;
      }
    </style>
  </head>
  <body>
    <main>
      <div id="messages"></div>
      <input id="picker" type="file" accept=".org"
             ondrop="dropHandler(event)"
             ondragenter="dragEnterHandler(event)"
             ondragleave="dragLeaveHandler(event)"/>
      <table id="stats" width="400">
        <thead>
          <tr>
            <th>strokes</th>
            <th>suggestions</th>
            <th>count</th>
            <th>saved</th>
          </tr>
        </thead>
        <tbody id="stats-body">
          <tr><td colspan="4" align="center">Please select a file.</td></tr>
        </tbody>
      </table>
      <small>* grouped by strokes and sorted by "severity", which is [count] * [strokes the suggestion saves]</small>
    </main>

    <script>
      const inputEl = document.querySelector("#picker");
      const messagesEl = document.querySelector("#messages");
      const statsBody = document.querySelector("#stats-body");

      inputEl.addEventListener("change", updateStats);

      function dropHandler(ev) {
        ev.preventDefault();
        ev.stopPropagation();
        inputEl.classList.remove("dragOver");
      }

      function dragEnterHandler(e) {
        inputEl.classList.add("dragOver");
        e.preventDefault();
        e.stopPropagation();
      }

      function dragLeaveHandler(e) {
        inputEl.classList.remove("dragOver");
        e.preventDefault();
        e.stopPropagation();
      }

      function showMessage(message, type) {
        messagesEl.textContent = message;
        messagesEl.style.color = type === "error" ? "red" : "green";
      }

      function updateStats() {
        if (inputEl.files.length > 1) {
          showMessage("Multiple files found. Please only select one (1) file.", "error");
          return;
        }
        const file = inputEl.files[0];
        if (!file) {
          showMessage("No file selected. Please select a file.");
          return;
        }

        const reader = new FileReader();
        reader.onload = () => {
          try {
            const parsed = parseLog(reader.result);
            const analyzed = analyzeLog(parsed);
            showStats(analyzed);
            showMessage("File loaded successfully.", "success");
          } catch (e) {
            console.error(e);
            showMessage("Error parsing file content.", "error");
          }
        };
        reader.onerror = () => {
          showMessage("Error reading the file. Please try again.", "error");
        };
        reader.readAsText(file);
      }

      function parseLog(logContent) {
        const stats = {};
        const lines = logContent.split("\n");
        for (const line of lines) {
          if (line.includes("START") || line.includes("END") || line.trim() === "") continue;

          const cleaned = line.replace(ansiRegex(), "").trim();
          const match = cleaned.match(/(.+?)\s+(.+?)\s+<\s+(.+)/);
          if (!match) continue;

          const [_, translation, suggestionsStr, strokes] = match;
          const suggestions = suggestionsStr.split(/, ?/);
          const strokesSaved = suggestions.length;

          stats[strokes] = (stats[strokes] || []).concat([{
            strokesSaved,
            translation: translation.trim(),
            suggestions,
          }]);
        }
        return stats;
      }

      function analyzeLog(stats) {
        return Object.entries(stats).map(([stroke, instances]) => {
          let suggestions = [...new Set(instances.flatMap(i => i.suggestions))].join(', ');
          return {
            stroke,
            suggestions,
            count: instances.length,
            strokesSaved: instances[0].strokesSaved,
            severity: instances.reduce((acc, i) => acc + i.strokesSaved, 0),
          };
        });
      }

      function showStats(stats) {
        statsBody.innerHTML = ""; // Clear previous
        stats = stats.sort((a, b) => b.severity - a.severity);

        for (let {stroke, suggestions, count, strokesSaved} of stats) {
          const row = document.createElement("tr");

          row.innerHTML = `
            <td style="font-family:monospace;color:#ce8cac">${stroke}</td>
            <td style="font-family:monospace;color:#93bd8e">${suggestions}</td>
            <td style="font-family:monospace;color:#e5823a">${count}</td>
            <td style="font-family:monospace;color:#e5823a">${strokesSaved}</td>
          `;

          statsBody.appendChild(row);
        }

        if (stats.length === 0) {
          statsBody.innerHTML = `<tr><td colspan="4" align="center">No data parsed.</td></tr>`;
        }
      }

      // ANSI regex from chalk
      function ansiRegex({onlyFirst = false} = {}) {
        const ST = '(?:\\u0007|\\u001B\\u005C|\\u009C)';
        const pattern = [
          `[\\u001B\\u009B][[\\]()#;?]*(?:(?:(?:(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]+)*|[a-zA-Z\\d]+(?:;[-a-zA-Z\\d\\/#&.:=?%@~_]*)*)?${ST})`,
          '(?:(?:\\d{1,4}(?:;\\d{0,4})*)?[\\dA-PR-TZcf-nq-uy=><~]))',
        ].join('|');
        return new RegExp(pattern, onlyFirst ? undefined : 'g');
      }
    </script>
  </body>
</html>
